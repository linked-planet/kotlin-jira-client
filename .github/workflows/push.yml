name: Docker Compose Actions Workflow
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
#      - name: docker hub login
#        uses: docker/login-action@v1
#        with:
#          username: ${{ secrets.USERNAME }}
#          password: ${{ secrets.PASSWORD }}
#      - name: Startup Jira and Insight
#        run: docker-compose up -d
#      - name: Wait for Jira and Insight
#        run: ./scripts/waitingForJira.sh
#      - name: Build and Test library
#        run: ./gradlew test install --info
#      - name: Build and Test confluence library
#        run: mvn clean -f kotlin-jira-wrapper-atlas-test/pom.xml -B verify -Dbaseurl=http://localhost:1990
      - uses: actions/checkout@v2
      - name: Build and Test library
        run: ./gradlew clean install
        env:
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN }}
      # The USERNAME and TOKEN need to correspond to the credentials environment variables used in
      # the publishing section of your build.gradle
      - name: Publish to GitHub Packages
        run: |
          NEW_VERSION=$(./gradlew cV | grep "Project version" | cut -d ":" -f2 | xargs | awk '{print $1}') 
          NEW_OLD_VERSION=$(./gradlew cV | grep "Project version" | cut -d ":" -f2 | xargs) 
          echo "New old version: ${NEW_OLD_VERSION}"
          echo "New version: ${NEW_VERSION}"
          echo "Github username: ${GITHUB_ACTOR}"
          ./gradlew -Pversion=$NEW_VERSION publish
        env:
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN }}